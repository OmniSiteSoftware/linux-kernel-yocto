 /*
 * Copyright 2022-2024 Digi International Inc.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <dt-bindings/rtc/rtc-stm32.h>
/* Digi ConnectCore MP15 non-wireless FCT */
#include "ccmp157-mfg-functional.dts"

/ {
	bluetooth {
		/* U-Boot will fill in the MAC address here */
	};

	wireless {
		/* U-Boot will fill in the MAC address here */
	};

	aliases {
		serial1 = "/soc/serial@5c000000";
	};
};

/* Enable the RF regulator */
&reg_3v3_rf{
	compatible = "regulator-fixed";
	regulator-name = "3v3_rf";
	regulator-min-microvolt = <3300000>;
	regulator-max-microvolt = <3300000>;
	gpio = <&gpiof 2 GPIO_ACTIVE_HIGH>; /* 3V3_RF_EN */
	enable-active-high;
	startup-delay-us = <100000>;
	status = "okay";
};

/* Enable the WL regulator */
&reg_rf_wl_en{
	compatible = "regulator-fixed";
	regulator-name = "rf_wl_en";
	regulator-min-microvolt = <3300000>;
	regulator-max-microvolt = <3300000>;
	gpio = <&gpiod 13 GPIO_ACTIVE_HIGH>; /* WL_EN */
	enable-active-high;
	startup-delay-us = <100>;
	vin-supply = <&reg_3v3_rf>;
	status = "okay";
};

&rtc{
	st,lsco = <RTC_OUT2_RMP>;
	pinctrl-0 = <&ccmp15_rtc_out1_pins_a &rtc_out2_rmp_pins_a>;
	pinctrl-names = "default";
	status = "okay";
};

/* Enable SDMMC3 (Wireless) */
&sdmmc3{
	pinctrl-names = "default", "opendrain", "sleep";
	pinctrl-0 = <&sdmmc3_b4_pins_a>;
	pinctrl-1 = <&sdmmc3_b4_od_pins_a>;
	pinctrl-2 = <&sdmmc3_b4_sleep_pins_a>;
	non-removable;
	no-1-8-v;
	st,neg-edge;
	bus-width = <4>;
	vmmc-supply = <&reg_rf_wl_en>;
	max-frequency = <1000000>;
	status = "okay";

	brcmf {
		compatible = "brcm,bcm4329-fmac";

		brcm,broken_sg_support;
		brcm,sd_head_align = /bits/  16 <8>;
		brcm,sd_sgentry_align = /bits/ 16 <32>;
	};
};

/* Enable USART1 (Bluetooth) */
&usart1{
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&ccmp15_usart1_pins_c>, <&ccmp15_usart1_pins_z>;
	pinctrl-1 = <&ccmp15_usart1_sleep_pins_c>, <&ccmp15_usart1_sleep_pins_z>;
	uart-has-rtscts;
	status = "okay";

	cyw4373_bt {
		shutdown-gpios = <&gpioz 6 GPIO_ACTIVE_HIGH>;
		compatible = "brcm,bcm43438-bt";
		max-speed = <3000000>;
		vbat-supply = <&v3v3>;
		vddio-supply = <&reg_3v3_rf>;
		status = "okay";
	};
};
